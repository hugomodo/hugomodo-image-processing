{{/* TODO: Currently works for a /uploads directory. Generalise it! */}}

{{ $images := .content | findRE "[!][[].*?[]][(]/uploads/.*?[)]" | uniq }}

{{ .context.Scratch.Set "content" .content }}

{{ range $images }}
  {{ $image := . | replaceRE "[!][[].*?[]][(]/uploads/(.*?)[)]" "$1" }}
  {{ $regex := printf "[!][[].*?[]][(]/uploads/%s[)]" $image }}
  {{ $.context.Scratch.Set "content" ($.context.Scratch.Get "content" | replaceRE $regex (partial "image-processing/imgproc.html" (dict "context" ($.context.Site.GetPage "uploads") "src" $image))) }}
{{ end }}

{{ .context.Scratch.Get "content" }}
